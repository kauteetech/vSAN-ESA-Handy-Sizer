

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vSAN ESA Handy Sizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f5f6f5; margin: 0; padding: 1.5rem; min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow: auto; color: #2f353a; }
        .container { background: #fff; width: 100%; max-width: 1400px; min-height: calc(100vh - 3rem); display: flex; flex-direction: column; box-shadow: 0 0.25rem 0.5rem rgba(47, 53, 58, 0.1); border-radius: 0.5rem; overflow: hidden; }
        .header { background: #ebedef; padding: 1.5rem; text-align: center; border-bottom: 1px solid #d2d4d6; position: relative; }
        .header h1 { font-size: 1.75rem; font-weight: 700; margin: 0; color: #2f353a; }
        .toggle-btn { position: absolute; top: 1.5rem; left: 1.5rem; padding: 0.5rem 1rem; background: #3b82f6; color: #fff; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .help-icon, .log-icon { position: absolute; top: 1.5rem; font-size: 1.5rem; cursor: pointer; color: #3b82f6; }
        .help-icon { right: 1.5rem; }
        .log-icon { right: 3.5rem; }
        .main-content { flex: 1; display: flex; padding: 1.5rem; gap: 1.5rem; flex-wrap: wrap; }
        .card { background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(47, 53, 58, 0.075); }
        .input-panel { width: 300px; overflow-y: auto; max-height: calc(100vh - 6rem); flex-shrink: 0; }
        .output-panel { flex: 1; display: flex; flex-direction: column; gap: 1.5rem; min-width: 300px; }
        .chart-section { display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap; }
        .results-utilization { display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap; }
        .chart-container { max-width: 300px; max-height: 300px; width: 100%; }
        .results-section, .progress-section { min-width: 250px; max-width: 350px; }
        .license-section { max-width: 400px; align-self: center; border: 2px solid #ff6b6b; background: #ffebeb; animation: blink 2s infinite; }
        h2 { font-size: 1.25rem; font-weight: 700; color: #2f353a; margin-bottom: 1rem; }
        label { font-size: 0.9rem; font-weight: 600; color: #697077; display: inline; margin-right: 0.5rem; }
        .slider-container { margin: 0.75rem 0; }
        .label-value-container { display: flex; align-items: center; margin-bottom: 0.25rem; }
        .slider-control { display: flex; align-items: center; gap: 0.5rem; }
        input[type="range"] { flex: 1; accent-color: #3b82f6; }
        .slider-btn { width: 1.5rem; height: 1.5rem; background: #ebedef; border: 1px solid #d2d4d6; border-radius: 0.25rem; font-size: 1rem; font-weight: 600; color: #2f353a; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .slider-btn:hover { background: #d2d4d6; }
        .slider-btn:disabled { background: #f5f6f5; color: #697077; cursor: not-allowed; }
        select { width: 100%; padding: 0.4rem 0.8rem; border: 1px solid #d2d4d6; border-radius: 0.375rem; background: #fff; color: #2f353a; font-size: 0.9rem; font-weight: 500; margin: 0.75rem 0; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
        .slider-value { font-size: 1rem; font-weight: 500; color: #2f353a; background: #ebedef; padding: 0.25rem 0.5rem; border-radius: 0.25rem; display: inline-block; }
        .progress-bar { width: 100%; height: 1rem; background: #ebedef; border-radius: 0.375rem; overflow: hidden; margin: 0.25rem 0; position: relative; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.5s ease; }
        .progress-label { font-size: 0.9rem; font-weight: 600; color: #2f353a; }
        .result-text { font-size: 0.9rem; font-weight: 600; color: #2f353a; margin: 0.5rem 0; }
        .warning { color: #dc2626; font-weight: 700; }
        .license-section p { font-size: 0.9rem; font-weight: 600; color: #2f353a; margin: 0; }
        .tooltip { visibility: hidden; background: #2f353a; color: #fff; font-size: 0.8rem; padding: 0.5rem; border-radius: 0.25rem; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); white-space: pre-wrap; }
        .progress-bar:hover .tooltip { visibility: visible; }
        .help-card, .log-card { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 0.25rem 0.5rem rgba(47, 53, 58, 0.3); max-width: 500px; z-index: 1000; }
        .help-card h3, .log-card h3 { font-size: 1.5rem; font-weight: 700; color: #2f353a; margin-bottom: 1rem; }
        .help-card ol, .log-card pre { font-size: 0.9rem; font-weight: 500; color: #2f353a; padding-left: 1.5rem; }
        .log-card pre { padding: 0; white-space: pre-wrap; }
        .help-card button, .log-card button { margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: #fff; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .advanced-only { display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @media (max-width: 768px) { .main-content { flex-direction: column; padding: 1rem; } .input-panel { width: 100%; max-width: 100%; } .results-utilization { flex-direction: column; align-items: center; } }
        @media (min-width: 960px) { .input-panel { overflow-x: hidden; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="toggle-btn" onclick="toggleMode()">Toggle Simple/Advanced</button>
            <h1>vSAN ESA Handy Sizer</h1>
            <span class="log-icon" onclick="toggleLog()">ðŸ“‹</span>
            <span class="help-icon" onclick="toggleHelp()">?</span>
        </div>
        <div class="main-content">
            <div class="card input-panel">
                <h2>Configure Your Cluster</h2>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Number of VMs</label>
                        <span id="numVMsValue" class="slider-value">500</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('numVMs', -1)">âˆ’</button>
                        <input type="range" id="numVMs" min="1" max="10000" value="500" oninput="updateSliderValue('numVMs'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('numVMs', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>IOPS per VM</label>
                        <span id="iopsPerVMValue" class="slider-value">500</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('iopsPerVM', -1)">âˆ’</button>
                        <input type="range" id="iopsPerVM" min="1" max="1000" value="500" oninput="updateSliderValue('iopsPerVM'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('iopsPerVM', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>vCPU per VM</label>
                        <span id="vcpuPerVMValue" class="slider-value">2</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('vcpuPerVM', -1)">âˆ’</button>
                        <input type="range" id="vcpuPerVM" min="1" max="32" value="2" oninput="updateSliderValue('vcpuPerVM'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('vcpuPerVM', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>Memory per VM (GB)</label>
                        <span id="memoryPerVMValue" class="slider-value">4</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('memoryPerVM', -1)">âˆ’</button>
                        <input type="range" id="memoryPerVM" min="1" max="128" value="4" oninput="updateSliderValue('memoryPerVM'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('memoryPerVM', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Used Capacity per VM (GB)</label>
                        <span id="capacityPerVMValue" class="slider-value">200</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('capacityPerVM', -1)">âˆ’</button>
                        <input type="range" id="capacityPerVM" min="1" max="1024" value="200" oninput="updateSliderValue('capacityPerVM'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('capacityPerVM', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Number of Hosts</label>
                        <span id="numHostsValue" class="slider-value">7</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('numHosts', -1)">âˆ’</button>
                        <input type="range" id="numHosts" min="3" max="64" value="7" oninput="updateSliderValue('numHosts'); syncHFTandRAID(); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('numHosts', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>Cores per Socket</label>
                        <span id="coresPerSocketValue" class="slider-value">28</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('coresPerSocket', -1)">âˆ’</button>
                        <input type="range" id="coresPerSocket" min="1" max="64" value="28" oninput="updateSliderValue('coresPerSocket'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('coresPerSocket', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>Sockets per Host</label>
                        <span id="socketsPerHostValue" class="slider-value">2</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('socketsPerHost', -1)">âˆ’</button>
                        <input type="range" id="socketsPerHost" min="1" max="4" value="2" oninput="updateSliderValue('socketsPerHost'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('socketsPerHost', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container advanced-only">
                    <div class="label-value-container">
                        <label>Max Memory per Host (GB)</label>
                        <span id="maxMemoryValue" class="slider-value">768</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('maxMemory', -1)">âˆ’</button>
                        <input type="range" id="maxMemory" min="64" max="2048" value="768" oninput="updateSliderValue('maxMemory'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('maxMemory', 1)">+</button>
                    </div>
                </div>
                <label>Drive Capacity (TB)</label>
                <select id="driveCapacity" onchange="calculateSizing()">
                    <option value="1.6">1.6 TB</option>
                    <option value="1.92">1.92 TB</option>
                    <option value="3.2">3.2 TB</option>
                    <option value="3.84">3.84 TB</option>
                    <option value="6.4" selected>6.4 TB</option>
                    <option value="7.62">7.62 TB</option>
                    <option value="7.68">7.68 TB</option>
                    <option value="12.8">12.8 TB</option>
                    <option value="15.36">15.36 TB</option>
                </select>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Max Drive Slots</label>
                        <span id="maxDriveSlotsValue" class="slider-value">7</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('maxDriveSlots', -1)">âˆ’</button>
                        <input type="range" id="maxDriveSlots" min="1" max="24" value="7" oninput="updateSliderValue('maxDriveSlots'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('maxDriveSlots', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Compression Ratio</label>
 Specialists <span id="compressionRatioValue" class="slider-value">1.4</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('compressionRatio', -0.1)">âˆ’</button>
                        <input type="range" id="compressionRatio" min="1" max="3" step="0.1" value="1.4" oninput="updateSliderValue('compressionRatio'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('compressionRatio', 0.1)">+</button>
                    </div>
                </div>
                <label>Host Failures to Tolerate (HFT)</label>
                <select id="hft" onchange="syncHFTandRAID(); calculateSizing()">
                    <option value="0">FTT0</option>
                    <option value="1">FTT1</option>
                    <option value="2" selected>FTT2</option>
                    <option value="3">FTT3</option>
                </select>
                <label>RAID Level</label>
                <select id="raidLevel" onchange="calculateSizing()">
                    <option value="0">FTT0</option>
                    <option value="1">RAID-1</option>
                    <option value="5">RAID-5</option>
                    <option value="6">RAID-6</option>
                </select>
                <div class="slider-container">
                    <div class="label-value-container">
                        <label>Growth Factor (%)</label>
                        <span id="growthFactorValue" class="slider-value">10</span>
                    </div>
                    <div class="slider-control">
                        <button class="slider-btn" onclick="adjustSlider('growthFactor', -1)">âˆ’</button>
                        <input type="range" id="growthFactor" min="0" max="50" value="10" oninput="updateSliderValue('growthFactor'); calculateSizing()">
                        <button class="slider-btn" onclick="adjustSlider('growthFactor', 1)">+</button>
                    </div>
                </div>
                <!-- Advanced VM I/O Profile -->
                <label class="advanced-only">VM I/O Profile (Read:Write)</label>
                <select id="ioProfileRW" class="advanced-only" onchange="calculateSizing()">
                    <option value="10:90">10% Read : 90% Write</option>
                    <option value="20:80">20% Read : 80% Write</option>
                    <option value="30:70">30% Read : 70% Write</option>
                    <option value="40:60">40% Read : 60% Write</option>
                    <option value="50:50">50% Read : 50% Write</option>
                    <option value="60:40" selected>60% Read : 40% Write</option>
                    <option value="70:30">70% Read : 30% Write</option>
                    <option value="80:20">80% Read : 20% Write</option>
                    <option value="90:10">90% Read : 10% Write</option>
                </select>
                <label class="advanced-only">VM I/O Profile (Block Size)</label>
                <select id="ioProfileBlock" class="advanced-only" onchange="calculateSizing()">
                    <option value="4">4KB</option>
                    <option value="16">16KB</option>
                    <option value="32">32KB</option>
                    <option value="64">64KB</option>
                    <option value="128">128KB</option>
                    <option value="256">256KB</option>
                    <option value="512">512KB</option>
                    <option value="1024">1MB</option>
                    <option value="4096">4MB</option>
                    <option value="16384">16MB</option>
                    <option value="65536">64MB</option>
                </select>
            </div>
            <div class="output-panel">
                <div class="chart-section">
                    <div class="card">
                        <div class="chart-container">
                            <canvas id="computeChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="chart-container">
                            <canvas id="storageChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="results-utilization">
                    <div class="card results-section">
                        <h2>Sizing Results</h2>
                        <p class="result-text"><strong>Total Hosts:</strong> <span id="totalHosts"></span></p>
                        <p class="result-text"><strong>Avg VMs per Host:</strong> <span id="vmsPerHost"></span></p>
                        <p class="result-text advanced-only"><strong>Avg IOPS per VM:</strong> <span id="avgIOPSPerVM"></span></p>
                        <p class="result-text advanced-only"><strong>Total IOPS Required:</strong> <span id="totalIOPS"></span></p>
                        <p class="result-text"><strong>Total Storage Required (TB):</strong> <span id="totalStorageRequired"></span></p>
                        <p class="result-text"><strong>Total Configured Storage (TB):</strong> <span id="totalConfiguredStorage"></span></p>
                        <p class="result-text"><strong>Total Used Capacity (TB):</strong> <span id="effectiveCapacity"></span></p>
                        <p class="result-text"><strong>Total Free Storage (TB):</strong> <span id="totalFreeStorage"></span></p>
                    </div>
                    <div class="card progress-section">
                        <h2>Utilization</h2>
                        <div class="progress-label advanced-only">CPU Utilization</div>
                        <div class="progress-bar advanced-only">
                            <div id="cpuProgress" class="progress-fill"></div>
                            <span id="cpuTooltip" class="tooltip"></span>
                        </div>
                        <div class="progress-label advanced-only">Memory Utilization</div>
                        <div class="progress-bar advanced-only">
                            <div id="memoryProgress" class="progress-fill"></div>
                            <span id="memoryTooltip" class="tooltip"></span>
                        </div>
                        <div class="progress-label">Storage Utilization</div>
                        <div class="progress-bar">
                            <div id="storageProgress" class="progress-fill"></div>
                            <span id="storageTooltip" class="tooltip"></span>
                        </div>
                    </div>
                </div>
                <div class="card license-section">
                    <h2>vSAN Add-on Licenses</h2>
                    <p><span id="licenseRequirement"></span></p>
                </div>
            </div>
        </div>
    </div>
    <div class="help-card" id="helpCard">
        <h3>How to Use vSAN ESA Handy Sizer</h3>
        <ol>
            <li><strong>Simple Mode:</strong> Set VMs, capacity, hosts, drives, RAID for basic sizing.</li>
            <li><strong>Advanced Mode:</strong> Add IOPS, CPU, memory, and I/O profiles for detailed results.</li>
            <li><strong>Toggle Mode:</strong> Switch with the top-left button.</li>
            <li><strong>Review Outputs:</strong> Check charts, results, and log (click ðŸ“‹).</li>
        </ol>
        <button onclick="toggleHelp()">Close</button>
    </div>
    <div class="log-card" id="logCard">
        <h3>Sizing Log</h3>
        <pre id="sizingLog"></pre>
        <button onclick="toggleLog()">Close</button>
    </div>

    <script>
        let computeChart, storageChart, isAdvancedMode = false;

        function updateSliderValue(id) {
            const slider = document.getElementById(id);
            document.getElementById(`${id}Value`).textContent = slider.step < 1 ? parseFloat(slider.value).toFixed(1) : slider.value;
        }

        function adjustSlider(id, delta) {
            const slider = document.getElementById(id);
            const step = parseFloat(slider.step) || 1;
            let newValue = parseFloat(slider.value) + (delta * step);
            newValue = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), newValue));
            slider.value = newValue;
            updateSliderValue(id);
            if (id === 'numHosts') syncHFTandRAID();
            calculateSizing();
        }

        function syncHFTandRAID() {
            const hft = parseInt(document.getElementById('hft').value) || 0;
            const numHosts = parseInt(document.getElementById('numHosts').value) || 3;
            const raidSelect = document.getElementById('raidLevel');
            const options = raidSelect.options;
            let validRaid = raidSelect.value;

            // Hide all options initially
            for (let i = 0; i < options.length; i++) {
                options[i].style.display = 'none';
                options[i].disabled = true;
            }

            // vSAN ESA minimum host requirements per RAID and FTT
            if (hft === 0) {
                options[0].style.display = 'block'; // RAID-0 (FTT0)
                options[0].disabled = false;
                validRaid = '0';
            } else if (hft === 1) {
                if (numHosts >= 3) {
                    options[1].style.display = 'block'; // RAID-1 (FTT=1, 3 hosts min)
                    options[1].disabled = false;
                    options[2].style.display = 'block'; // RAID-5 (FTT=1, 3 hosts min for 2+1)
                    options[2].disabled = false;
                    if (numHosts >= 6 && validRaid === '5') {
                        // RAID-5 4+1 scheme for 6+ hosts
                    } else if (validRaid === '6') {
                        validRaid = '1'; // Reset to RAID-1 if RAID-6 was selected
                    }
                }
                validRaid = validRaid === '0' || validRaid === '6' ? '1' : validRaid;
            } else if (hft === 2) {
                if (numHosts >= 5) {
                    options[1].style.display = 'block'; // RAID-1 (FTT=2, 5 hosts min)
                    options[1].disabled = false;
                }
                if (numHosts >= 6) {
                    options[3].style.display = 'block'; // RAID-6 (FTT=2, 6 hosts min)
                    options[3].disabled = false;
                }
                validRaid = (validRaid === '6' && numHosts >= 6) ? '6' : (numHosts >= 5 ? '1' : '1');
            } else if (hft === 3) {
                if (numHosts >= 7) {
                    options[1].style.display = 'block'; // RAID-1 (FTT=3, 7 hosts min)
                    options[1].disabled = false;
                }
                validRaid = numHosts >= 7 ? '1' : '1';
            }

            raidSelect.value = validRaid;
        }

        function toggleMode() {
            isAdvancedMode = !isAdvancedMode;
            document.querySelectorAll('.advanced-only').forEach(el => el.style.display = isAdvancedMode ? 'block' : 'none');
            document.querySelector('.toggle-btn').textContent = isAdvancedMode ? 'Switch to Simple' : 'Switch to Advanced';
            calculateSizing();
        }

        function toggleHelp() {
            const helpCard = document.getElementById('helpCard');
            helpCard.style.display = helpCard.style.display === 'block' ? 'none' : 'block';
        }

        function toggleLog() {
            const logCard = document.getElementById('logCard');
            logCard.style.display = logCard.style.display === 'block' ? 'none' : 'block';
            if (logCard.style.display === 'block') calculateSizing();
        }

        function calculateSizing() {
            // --- Input Collection ---
            const numVMs = parseInt(document.getElementById('numVMs').value) || 1;
            const iopsPerVM = isAdvancedMode ? parseFloat(document.getElementById('iopsPerVM').value) || 1 : 0;
            const vcpuPerVM = isAdvancedMode ? parseInt(document.getElementById('vcpuPerVM').value) || 1 : 0;
            const memoryPerVM = isAdvancedMode ? parseFloat(document.getElementById('memoryPerVM').value) || 1 : 0;
            const capacityPerVM = parseFloat(document.getElementById('capacityPerVM').value) || 1; // GB
            let numHosts = parseInt(document.getElementById('numHosts').value);
            const coresPerSocket = isAdvancedMode ? parseInt(document.getElementById('coresPerSocket').value) || 1 : 32;
            const socketsPerHost = isAdvancedMode ? parseInt(document.getElementById('socketsPerHost').value) || 1 : 2;
            const maxMemory = isAdvancedMode ? parseFloat(document.getElementById('maxMemory').value) || 1 : 768;
            const driveCapacity = parseFloat(document.getElementById('driveCapacity').value);
            const maxDriveSlots = parseInt(document.getElementById('maxDriveSlots').value) || 1;
            const compressionRatio = parseFloat(document.getElementById('compressionRatio').value);
            let hft = parseInt(document.getElementById('hft').value) || 0;
            let raidLevel = document.getElementById('raidLevel').value;
            const growthFactor = parseFloat(document.getElementById('growthFactor').value) || 0;
            const ioProfileRW = isAdvancedMode ? document.getElementById('ioProfileRW').value : '60:40';
            const ioProfileBlock = isAdvancedMode ? parseInt(document.getElementById('ioProfileBlock').value) : 4;

            // --- Enforce vSAN ESA Minimum Host Requirements ---
            let minHostsRequired = 3; // Default minimum for vSAN ESA
            if (hft === 0) {
                minHostsRequired = 1;
            } else if (hft === 1) {
                minHostsRequired = (raidLevel === '5') ? 3 : 3; // RAID-5 2+1 or RAID-1
            } else if (hft === 2) {
                minHostsRequired = (raidLevel === '6') ? 6 : 5; // RAID-6 needs 6, RAID-1 needs 5
            } else if (hft === 3) {
                minHostsRequired = 7; // RAID-1 only
            }

            if (numHosts < minHostsRequired) {
                numHosts = minHostsRequired;
                document.getElementById('numHosts').value = numHosts;
                updateSliderValue('numHosts');
            }

            // Adjust RAID and HFT if incompatible
            if (hft === 2 && raidLevel === '6' && numHosts < 6) {
                raidLevel = '1'; // Fallback to RAID-1
                document.getElementById('raidLevel').value = '1';
            } else if (hft === 1 && raidLevel === '5' && numHosts >= 6) {
                // RAID-5 switches to 4+1 scheme, no change needed
            }

            // --- RAID Configuration ---
            let raidOverhead, raidDescription, writePenalty;
            if (raidLevel === '0') { 
                raidOverhead = 1; 
                raidDescription = "No mirroring or parity (FTT0)"; 
                writePenalty = 1;
            } else if (raidLevel === '1') { 
                raidOverhead = 2; 
                raidDescription = "Mirroring (RAID-1, 50% capacity used)"; 
                writePenalty = 2;
            } else if (raidLevel === '5') { 
                raidOverhead = numHosts < 6 ? 1.5 : 1.25; 
                raidDescription = numHosts < 6 ? "Erasure Coding (RAID-5, 2D+1P, 33% parity)" : "Erasure Coding (RAID-5, 4D+1P, 20% parity)"; 
                writePenalty = numHosts < 6 ? 3 : 4;
            } else if (raidLevel === '6') { 
                raidOverhead = 1.5; 
                raidDescription = "Erasure Coding (RAID-6, 4D+2P, 33% parity)"; 
                writePenalty = 6;
            }
            const minClusterSize = raidLevel === '6' ? 6 : (raidLevel === '5' ? (numHosts < 6 ? 3 : 6) : (raidLevel === '1' ? 3 : 1));
            numHosts = Math.max(numHosts, minClusterSize);

            // --- Constants ---
            const clockSpeed = 2.0; // GHz
            const lsfsOverhead = 0.111; // 11.1%
            const leafOverhead = 0.02; // 2%
            const metadataOverhead = 0.1; // 10%
            const hostFootprintMB = 10000;
            const diskFootprintMB = 1000;
            const systemMemoryOverhead = 0.05; // 5%
            const vcpuPerPcpu = 6; // HT assumed
            const nvmeIopsPerTB = { 4: 150000, 16: 120000, 32: 100000, 64: 80000, 128: 60000, 256: 40000, 
                                   512: 20000, 1024: 10000, 4096: 2500, 16384: 625, 65536: 156 };

            // --- I/O Profile Adjustments (Advanced Only) ---
            let totalIOPS = 0, avgIOPSPerVM = 0, totalStorageIOPS = 0, coresConsumedPerIops = 0;
            if (isAdvancedMode) {
                const [readPercent, writePercent] = ioProfileRW.split(':').map(Number);
                const writeMultiplier = writePenalty * (writePercent / 100);
                const readMultiplier = readPercent / 100;
                const ioMultiplier = readMultiplier + writeMultiplier;
                const blockSizeFactor = 4 / ioProfileBlock;
                totalIOPS = numVMs * iopsPerVM * ioMultiplier * blockSizeFactor;
                avgIOPSPerVM = iopsPerVM * ioMultiplier * blockSizeFactor;
                totalStorageIOPS = driveCapacity * maxDriveSlots * nvmeIopsPerTB[ioProfileBlock] * numHosts;
                coresConsumedPerIops = (0.0001 * ioMultiplier) / clockSpeed;
            }

            // --- CPU Calculations (Advanced Only) ---
            let totalCoresConsumed = 0, totalCores = 0, freeCores = 0;
            if (isAdvancedMode) {
                const totalCoresConsumedVSAN = coresConsumedPerIops * totalIOPS;
                const coresPerVM = vcpuPerVM / vcpuPerPcpu;
                const coresConsumedByApp = numVMs * coresPerVM;
                totalCoresConsumed = coresConsumedByApp + totalCoresConsumedVSAN;
                const totalCoresPerHost = coresPerSocket * socketsPerHost;
                totalCores = totalCoresPerHost * numHosts;
                freeCores = totalCores - totalCoresConsumed;
            }

            // --- Storage Calculations ---
            const totalStorageRequired = (numVMs * capacityPerVM) / 1000; // GB to TB
            const totalUsedCapacity = numVMs * capacityPerVM * (1 + growthFactor / 100); // GB with growth
            const effectiveUsedCapacity = (totalUsedCapacity * raidOverhead) / compressionRatio; // GB
            const lsfsOverheadTB = effectiveUsedCapacity * lsfsOverhead / 1000;
            const leafOverheadTB = effectiveUsedCapacity * leafOverhead / 1000;
            const effectiveCapacityWithOverheads = (effectiveUsedCapacity / 1000) + lsfsOverheadTB + leafOverheadTB;

            const rawStoragePerHost = driveCapacity * maxDriveSlots;
            const metadataOverheadTBPerHost = rawStoragePerHost * metadataOverhead;
            const operationsReserveGBPerHost = 765 + (100 * maxDriveSlots) + (0.05 * rawStoragePerHost * 1000);
            const operationsReserveTBPerHost = operationsReserveGBPerHost / 1000;
            const usableStoragePerHost = rawStoragePerHost - operationsReserveTBPerHost - metadataOverheadTBPerHost;

            const totalClusterRawCapacity = rawStoragePerHost * numHosts;
            const totalClusterUsableCapacity = usableStoragePerHost * numHosts;
            const totalClusterFreeCapacity = totalClusterUsableCapacity - effectiveCapacityWithOverheads;
            const totalConfiguredStorage = totalClusterRawCapacity;
            const totalOverheadCapacity = totalClusterRawCapacity - totalClusterUsableCapacity;

            // --- Memory Calculations (Advanced Only) ---
            let totalMemoryRequired = 0, totalMemory = 0, freeMemory = 0;
            if (isAdvancedMode) {
                const memoryPerHost = (numVMs * memoryPerVM) / numHosts;
                const vsanMemoryMB = hostFootprintMB + (maxDriveSlots * diskFootprintMB) + (maxMemory * 1000 * systemMemoryOverhead);
                const vsanMemoryGB = vsanMemoryMB / 1000;
                totalMemoryRequired = (memoryPerHost * (1 + growthFactor / 100) + vsanMemoryGB) * numHosts;
                totalMemory = maxMemory * numHosts;
                freeMemory = totalMemory - totalMemoryRequired;
            }

            // --- License Calculation ---
            const totalRawCapacityTiB = totalClusterRawCapacity * (1000 / 1024);
            const vcfLicensePerCoreTiB = 1;
            const vcfStorageLicenseTiB = totalCores * vcfLicensePerCoreTiB;
            const additionalVSANLicenseTiB = Math.max(0, totalRawCapacityTiB - vcfStorageLicenseTiB);
            const licenseRequirement = additionalVSANLicenseTiB > 0 ? `${Math.ceil(additionalVSANLicenseTiB)} TiB (vSAN Add-on)` : 'No Additional vSAN Licenses Required';

            // --- Utilization ---
            const finalHosts = numHosts;
            const finalVMsPerHost = Math.round(numVMs / finalHosts);
            const cpuOverprovisioned = isAdvancedMode && totalCoresConsumed > totalCores;
            const memoryOverprovisioned = isAdvancedMode && totalMemoryRequired > totalMemory;
            const storageOverprovisioned = effectiveCapacityWithOverheads > totalClusterUsableCapacity;

            const cpuUtilization = isAdvancedMode ? Math.min((totalCoresConsumed / totalCores) * 100, 100) : 0;
            const memoryUtilization = isAdvancedMode ? Math.min((totalMemoryRequired / totalMemory) * 100, 100) : 0;
            const storageUtilization = Math.min((effectiveCapacityWithOverheads / totalClusterUsableCapacity) * 100, 100);

            if (isAdvancedMode) {
                document.getElementById('cpuProgress').style.width = `${cpuUtilization}%`;
                document.getElementById('memoryProgress').style.width = `${memoryUtilization}%`;
            }
            document.getElementById('storageProgress').style.width = `${storageUtilization}%`;
            if (isAdvancedMode) {
                document.getElementById('cpuProgress').style.background = cpuOverprovisioned ? '#dc2626' : '#3b82f6';
                document.getElementById('memoryProgress').style.background = memoryOverprovisioned ? '#dc2626' : '#3b82f6';
            }
            document.getElementById('storageProgress').style.background = storageOverprovisioned ? '#dc2626' : '#3b82f6';

            // --- Output Updates ---
            document.getElementById('totalHosts').textContent = finalHosts;
            document.getElementById('vmsPerHost').textContent = finalVMsPerHost;
            document.getElementById('avgIOPSPerVM').textContent = isAdvancedMode ? avgIOPSPerVM.toFixed(2) : 'N/A';
            document.getElementById('totalIOPS').textContent = isAdvancedMode ? totalIOPS.toFixed(2) : 'N/A';
            document.getElementById('totalStorageIOPS').textContent = isAdvancedMode ? totalStorageIOPS.toFixed(2) : 'N/A';
            document.getElementById('totalStorageRequired').textContent = totalStorageRequired.toFixed(2);
            document.getElementById('totalConfiguredStorage').textContent = totalConfiguredStorage.toFixed(2);
            document.getElementById('effectiveCapacity').className = storageOverprovisioned ? 'result-text warning' : 'result-text';
            document.getElementById('effectiveCapacity').textContent = effectiveCapacityWithOverheads.toFixed(2) + (storageOverprovisioned ? ' (Overprovisioned)' : '');
            document.getElementById('totalFreeStorage').textContent = totalClusterFreeCapacity.toFixed(2);
            document.getElementById('licenseRequirement').textContent = licenseRequirement;

            if (isAdvancedMode) {
                document.getElementById('cpuTooltip').textContent = `Total CPU: ${totalCores.toFixed(2)} Cores\nUtilized: ${totalCoresConsumed.toFixed(2)} Cores\nFree: ${freeCores.toFixed(2)} Cores\nUtilized: ${cpuUtilization.toFixed(2)}%\nFree: ${(100 - cpuUtilization).toFixed(2)}%`;
                document.getElementById('memoryTooltip').textContent = `Total Memory: ${totalMemory.toFixed(2)} GB\nUtilized: ${totalMemoryRequired.toFixed(2)} GB\nFree: ${freeMemory.toFixed(2)} GB\nUtilized: ${memoryUtilization.toFixed(2)}%\nFree: ${(100 - memoryUtilization).toFixed(2)}%`;
            }
            document.getElementById('storageTooltip').textContent = `Total Usable Storage: ${totalClusterUsableCapacity.toFixed(2)} TB\nUtilized: ${effectiveCapacityWithOverheads.toFixed(2)} TB\nFree: ${totalClusterFreeCapacity.toFixed(2)} TB\nUtilized: ${storageUtilization.toFixed(2)}%\nFree: ${(100 - storageUtilization).toFixed(2)}%`;

            // --- Log Output ---
            let sizingLog = `
Storage Capacity Breakdown:
1. Raw Capacity: ${totalClusterRawCapacity.toFixed(2)} TB
   - Drives: ${driveCapacity} TB x ${maxDriveSlots} slots x ${numHosts} hosts
2. Overheads per Host:
   - System Metadata: ${metadataOverheadTBPerHost.toFixed(2)} TB (10%)
   - Operations Reserve: ${operationsReserveTBPerHost.toFixed(2)} TB
   - Usable per Host: ${usableStoragePerHost.toFixed(2)} TB
3. Total Usable Capacity (Post-RAID): ${totalClusterUsableCapacity.toFixed(2)} TB
4. VM Storage Needed: ${totalStorageRequired.toFixed(2)} TB
5. After Growth (${growthFactor}%): ${(totalUsedCapacity / 1000).toFixed(2)} TB
6. After RAID: ${(totalUsedCapacity * raidOverhead / 1000).toFixed(2)} TB
   - ${raidDescription}
7. After Compression (${compressionRatio}x): ${effectiveUsedCapacity.toFixed(2)} GB
8. Final Used Capacity: ${effectiveCapacityWithOverheads.toFixed(2)} TB
9. Free Capacity: ${totalClusterFreeCapacity.toFixed(2)} TB
`;
            if (numHosts > document.getElementById('numHosts').value) {
                sizingLog += `\nWARNING: Number of hosts increased to ${numHosts} to meet vSAN ESA minimum requirements for HFT=${hft} and RAID=${raidLevel}.`;
            }
            if (isAdvancedMode) {
                sizingLog += `
IOPS Breakdown:
1. Base IOPS: ${(numVMs * iopsPerVM).toFixed(2)}
2. After I/O Profile (${ioProfileRW}, ${ioProfileBlock}KB): ${totalIOPS.toFixed(2)}
3. Storage IOPS Capacity: ${totalStorageIOPS.toFixed(2)}

CPU Breakdown:
1. VM CPU: ${(numVMs * vcpuPerVM / vcpuPerPcpu).toFixed(2)} cores
2. vSAN CPU: ${(coresConsumedPerIops * totalIOPS).toFixed(2)} cores
3. Total CPU: ${totalCoresConsumed.toFixed(2)} cores
   - Out of ${totalCores} cores
`;
            }
            document.getElementById('sizingLog').textContent = sizingLog;

            // --- Charts ---
            if (computeChart) computeChart.destroy();
            const computeCtx = document.getElementById('computeChart').getContext('2d');
            computeChart = new Chart(computeCtx, {
                type: 'pie',
                data: {
                    labels: isAdvancedMode ? ['Utilized CPU (Cores)', 'Free CPU (Cores)', 'Utilized Memory (GB)', 'Free Memory (GB)'] : ['Cluster Raw Capacity (TB)', 'Overhead (TB)', 'VM Used Capacity (TB)', 'Free Capacity (TB)'],
                    datasets: [{
                        data: isAdvancedMode ? [totalCoresConsumed, Math.max(freeCores, 0), totalMemoryRequired, Math.max(freeMemory, 0)] : [totalClusterRawCapacity, totalOverheadCapacity, effectiveCapacityWithOverheads, Math.max(totalClusterFreeCapacity, 0)],
                        backgroundColor: isAdvancedMode ? [cpuOverprovisioned ? '#dc2626' : '#3b82f6', '#93c5fd', memoryOverprovisioned ? '#dc2626' : '#22c55e', '#86efac'] : ['#8b5cf6', '#d1d5db', storageOverprovisioned ? '#dc2626' : '#10b981', '#f97316']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: isAdvancedMode ? 'Compute Distribution' : 'Cluster Storage Distribution (TB)', font: { size: 16, weight: '700' } } } }
            });

            if (storageChart) storageChart.destroy();
            const storageCtx = document.getElementById('storageChart').getContext('2d');
            storageChart = new Chart(storageCtx, {
                type: 'pie',
                data: {
                    labels: ['Cluster Raw Capacity (TB)', 'Total Usable Capacity (Post-RAID, TB)', 'Free Capacity (Post-VM, TB)'],
                    datasets: [{
                        data: [totalClusterRawCapacity, totalClusterUsableCapacity, Math.max(totalClusterFreeCapacity, 0)],
                        backgroundColor: [storageOverprovisioned ? '#dc2626' : '#8b5cf6', '#10b981', '#f97316']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Cluster Storage Distribution (TB)', font: { size: 16, weight: '700' } } } }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateSliderValue('numVMs');
            updateSliderValue('iopsPerVM');
            updateSliderValue('vcpuPerVM');
            updateSliderValue('memoryPerVM');
            updateSliderValue('capacityPerVM');
            updateSliderValue('numHosts');
            updateSliderValue('coresPerSocket');
            updateSliderValue('socketsPerHost');
            updateSliderValue('maxMemory');
            updateSliderValue('maxDriveSlots');
            updateSliderValue('compressionRatio');
            updateSliderValue('growthFactor');
            syncHFTandRAID();
            calculateSizing();
        });
    </script>
</body>
</html>
